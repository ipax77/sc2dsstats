@using Microsoft.AspNetCore.Components.Web.Virtualization;
@using System.Globalization;
@using pax.dsstats.shared
@inject IDataService dataService

<style>
    .tableFixHead {
        overflow-y: auto;
        height: 750px;
        width: 400px;
    }
</style>

<h4>Player Ratings</h4>
<div class="row">
    <div class="col-auto tableFixHead">
        <table class="table table-dark table-hover">
            <thead>
                <tr>
                    <th>ToonId</th>
                    <th>Name</th>
                    <th>Rating</th>
                </tr>
            </thead>
            <tbody>
                @if (ratingsCount > 0)
                {
                    <Virtualize @ref="virtualize" Context="rating" ItemsProvider="LoadRatings">
                        <tr @onclick="e => LoadPlayerChart(rating)">
                            <td>@rating.ToonId</td>
                            <td>@rating.Name</td>
                            <td>@Math.Round(rating.Mmr, 2).ToString(CultureInfo.InvariantCulture)</td>
                        </tr>
                    </Virtualize>
                }
            </tbody>
        </table>
    </div>
    <div class="col-auto">
        <div>
            <PlayerRatingsDeviation @ref="playerRatingsDeviation"></PlayerRatingsDeviation>
        </div>
        <div>
            <PlayerRatingChart @ref="playerRatingChart"></PlayerRatingChart>
        </div>
    </div>
</div>

@code {
    private int ratingsCount = 0;
    private Order order = new()
        {
            Property = "Dsr",
            Ascending = false
        };
    private PlayerRatingChart? playerRatingChart;
    private PlayerRatingsDeviation? playerRatingsDeviation;
    private Virtualize<PlayerRatingDto>? virtualize;

    public async Task Reload()
    {
        await SetCount();
        await InvokeAsync(() => StateHasChanged());
        if (virtualize != null)
        {
            await virtualize.RefreshDataAsync();
        }
        await InvokeAsync(() => StateHasChanged());
        if (playerRatingsDeviation != null)
        {
            await playerRatingsDeviation.LoadData();
        }
    }

    protected override void OnInitialized()
    {
        _ = SetCount();
        base.OnInitialized();
    }

    private async Task SetCount()
    {
        ratingsCount = await dataService.GetRatingsCount();
        await InvokeAsync(() => StateHasChanged());
    }

    private async ValueTask<ItemsProviderResult<PlayerRatingDto>> LoadRatings(ItemsProviderRequest request)
    {
        var numRatings = Math.Min(request.Count, ratingsCount - request.StartIndex);
        var ratings = await dataService.GetRatings(request.StartIndex,
            numRatings, order, request.CancellationToken);

        return new ItemsProviderResult<PlayerRatingDto>(ratings, ratingsCount);
    }

    private void LoadPlayerChart(PlayerRatingDto playerRatingDto)
    {
        playerRatingChart?.LoadData(playerRatingDto.ToonId, playerRatingDto.Name);
    }
}
